# Subscription aggregator

REST API для агрегации данных об онлайн-подписках пользователей.

## Предварительная настройка (перед запуском)

Склонировать репозиторий и перейти в папку с репозиторием

```shell
git clone https://github.com/ej-you/SubscriptionAggregator.git
cd ./SubscriptionAggregator
```

В корне проекта необходимо создать файл .env и поместить в него переменные окружения:

```dotenv
POSTGRES_USER="aggregator"
POSTGRES_PASSWORD="p@SSw0rd"
POSTGRES_DB="aggregator_db"
PGDATA="/var/lib/postgresql/data/pgdata"

POSTGRES_HOST="postgresql"
POSTGRES_PORT="5432"
```

## Запуск

```shell
docker compose -f ./docker-compose.yml up -d
```

> !! Затем необходимо провести миграции, используя команду !!
>
> ```shell
> docker compose -f ./docker-compose.yml exec server sh -c "/app/migrator up"
> ```

По умолчанию сервер запускается на `8000` порту.

Swagger документация — `/api/v1/docs`.

[Ссылка](http://127.0.0.1:8000/api/v1/docs) на swagger документацию (локальный адрес).

Чтобы остановить сервер используйте

```shell
docker compose -f ./docker-compose.yml down
```

## Дополнительно

### Логирование

У приложения можно настроить уровень логирования и формат логов.

Доступные форматы логов:

1. text (по умолчанию)
2. json

Доступные уровни логирования

1. info (по умолчанию)
2. warn
3. error

Настройка происходит с помощью переменных окружения. Например:

```shell
LOG_FORMAT=text LOG_LEVEL=error go run ./cmd/app/main.go
```

### Работа ресурса для получения суммы

Этот ресурс работает с необязательными `query-параметрами` (ID юзера и название сервиса) и
обязательными параметрами начала и конца периода выборки.
Особенности выборки по датам начала/конца:

Будут выбраны записи по критериям:

- с датой начала, которая раньше данной, и отсутствующей датой конца
- с вхождением даты начала в полуинтервал `[start:end)`
- с вхождением интервала дат записи в интервал данных дат
- с вхождением даты конца в полуинтервал `(start:end]`

> *Все условия __для дат__ объединены через логическое `ИЛИ`
